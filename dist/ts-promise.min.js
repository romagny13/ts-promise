/*!
 * TSPromise v0.0.3
 * (c) 2017 romagny13
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.TSPromise=e()}(this,function(){"use strict";function t(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function e(t){return"function"==typeof t}var i,n=function(){function t(){this._cache={}}return t.prototype._generateKey=function(){return"__p_"+Math.random().toString(36).substr(2,9)},t.prototype._retrieve=function(t){if(this._cache.hasOwnProperty(t))return this._cache[t]},t.prototype.getNewId=function(){var t=this._generateKey(),e=t+".0";return this._cache[t]=[e],e},t.prototype.getId=function(t){if("string"==typeof t){var e=t.split(".")[0],i=this._retrieve(e);if(i){var n=e+"."+i.length;return this._cache[e].push(n),n}}return this.getNewId()},t}(),o=new n;!function(t){t[t.done=0]="done",t[t.fail=1]="fail",t[t.waitResult=2]="waitResult",t[t.waitSuccessCallBack=3]="waitSuccessCallBack",t[t.waitErrorCallBack=4]="waitErrorCallBack",t[t.none=5]="none"}(i||(i={}));var r;!function(t){t[t.all=0]="all",t[t.race=1]="race"}(r||(r={}));var s=function(){function t(){}return t.prototype._setPending=function(t,e){this._state=t,this._pending=e},t.prototype._handleSuccess=function(t){var e;try{this._isCompleted=!0,e=this.onSuccess(t),this._state=i.done,this._proxy.resolve(e)}catch(t){this._handleException(t)}},t.prototype._handleError=function(t){var e;try{this._isCompleted=!0,e=this.onError(t),this._state=i.fail,this._proxy.resolve(e)}catch(t){this._handleException(t)}},t.prototype.resolve=function(t){this._state===i.waitResult?this._handleSuccess(t):this._setPending(i.waitSuccessCallBack,t)},t.prototype.reject=function(t){this._state===i.waitResult?this._handleError(t):this._setPending(i.waitErrorCallBack,t)},t.prototype._handleException=function(t){this._isCompleted?this._proxy.reject(t):this.reject(t)},t}(),c=function(n){function s(t,e){var i=n.call(this)||this;return i._id=o.getNewId(),i._isCompleted=!1,i._promiseResults=[],i._pendingNotify=[],i._mode=e,i._promises=t,i._mode===r.all?i._iteratePromises(t):i._mode===r.race&&i._race(t),i}return t(s,n),s.prototype._handleNotifyAll=function(){var t=this;this._pendingNotify.length>0&&(this._pendingNotify.forEach(function(e){t.onNotify(e)}),this._pendingNotify=[])},s.prototype._onNotify=function(t){this.onNotify?this.onNotify(t):this._pendingNotify.push(t)},s.prototype._nextPromise=function(t,e,i,n){var o=this;t.then(function(t){o._onNotify(t),t&&o._promiseResults.push(t),i++,i<n?o._nextPromise(e[i],e,i,n):o.resolve(o._promiseResults)},function(t){o.reject(t)})},s.prototype._iteratePromises=function(t){var e=t.length,i=0;e>0?this._nextPromise(t[0],t,i,e):this.resolve([])},s.prototype._race=function(t){var e=this;t.forEach(function(t){t.then(function(t){e._isCompleted||(t&&e._promiseResults.push(t),e.resolve(t))},function(t){e.reject(t)})})},s.prototype.then=function(t,n,o){return this._proxy=new h(null,this._id),this._proxy._parent=this,this.onSuccess=t,this.onError=n,this.onNotify=o,e(this.onNotify)&&this._handleNotifyAll(),this._state===i.waitSuccessCallBack?this._handleSuccess(this._promiseResults):this._state===i.waitErrorCallBack?e(this.onError)&&this._handleError(this._pending):this._state=i.waitResult,this._proxy},s.prototype.catch=function(t){return this.then(this.onSuccess,t,this.onNotify)},s}(s),h=function(n){function s(t,i){var r=n.call(this)||this;i?r._id=o.getId(i):r._id=o.getNewId();try{e(t)&&t(function(t){r.resolve(t)},function(t){r.reject(t)})}catch(t){r._handleException(t)}return r}return t(s,n),s.prototype.then=function(t,e){return this._proxy=new s(null,this._id),this._proxy._parent=this,this.onSuccess=t,this.onError=e,this._state===i.waitSuccessCallBack?this._handleSuccess(this._pending):this._state===i.waitErrorCallBack?this.onError&&this._handleError(this._pending):this._state=i.waitResult,this._proxy},s.prototype.catch=function(t){return this._parent.then(null,t)},s.all=function(t){return new c(t,r.all)},s.race=function(t){return new c(t,r.race)},s}(s);return h});